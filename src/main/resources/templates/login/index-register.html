<!DOCTYPE html>
<meta charset="utf-8"/>
<html
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://www.thymeleaf.org"
        layout:decorate="~{base/layout}">
<div layout:fragment="content">
    <!--med_tittle_section-->
    <div class="med_tittle_section">
        <div class="med_img_overlay"></div>
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="med_tittle_cont_wrapper">
                        <div class="med_tittle_cont">
                            <ol class="breadcrumb">
                                <li><a th:href="@{/}">首页</a></li>
                                <li>注册</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- med_tittle_section End -->
    <!--service section start-->
    <div class="page-container">
        <div class="container">
            <div class="row med_toppadder50 med_bottompadder50">
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 col-lg-offset-3 col-md-offset-3">
                    <form action="#" method="post" class="cy-form boxed" id="form-submit">
                        <header>新用户注册</header>
                        <fieldset>
                            <section>
                                <label class="input">
                                    <i class="icon-append fa fa-user"></i>
                                    <input required type="text" placeholder="用户名" name="username" id="username">
                                    <b class="tooltip tooltip-bottom-right">请输入正确的用户名,可用于登录和找回密码(必选)</b>
                                </label>
                            </section>
                            <!--<section>-->
                            <!--<label class="input">-->
                            <!--<i class="icon-append fa fa-envelope"></i>-->
                            <!--<input required type="email" placeholder="邮箱地址">-->
                            <!--<b class="tooltip tooltip-bottom-right">用于验证用户(必选)</b>-->
                            <!--</label>-->
                            <!--</section>-->

                            <section>
                                <label class="input">
                                    <i class="icon-append fa fa-lock"></i>
                                    <input required type="password" placeholder="密码" name="password" id="password">
                                    <b class="tooltip tooltip-bottom-right">建议使用字母加数字或符号组合(必选)</b>
                                </label>
                            </section>

                            <section>
                                <label class="input">
                                    <i class="icon-append fa fa-lock"></i>
                                    <input required type="password" placeholder="确认密码" name="re-pass">
                                    <b class="tooltip tooltip-bottom-right">请重复输入注册密码(必选)</b>
                                </label>
                            </section>
                            <!--<section>-->
                            <!--<label class="input">-->
                            <!--<i class="icon-append fa fa-building"></i>-->
                            <!--<input type="text" placeholder="单位">-->
                            <!--<b class="tooltip tooltip-bottom-right">请输入单位名称(可选)</b>-->
                            <!--</label>-->
                            <!--</section>-->
                            <div class="row">
                                <section class="col col-md-6">
                                    <label class="input">
                                        <i class="icon-append fa fa-key"></i>
                                        <input required type="text" placeholder="验证码">
                                        <b class="tooltip tooltip-bottom-right">输入验证码</b>
                                    </label>
                                </section>
                                <section class="col col-md-6">
                                    <label class="input med_toppadder5">
                                        <img src="images/vcode.jpg">
                                        <a class="change" href="javascript:void(0);">换一张</a>
                                    </label>
                                </section>
                            </div>
                            <section>
                                <label class="checkbox"><input type="checkbox" name="checkbox-inline"><i></i>我已经阅读并接受 <a
                                        href="javascript:void(0);">免责声明</a></label>
                            </section>
                        </fieldset>


                        <footer>
                            <button type="reset" class="button button-secondary">重 置</button>
                            <button type="submit" class="button" onclick="saveForm()">注 册</button>
                        </footer>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <script th:inline="javascript">

        function saveForm() {
            var username = $("input[name='username']").val();
            var password = $("input[name='password']").val();
            var re_pass = $("input[name='re-pass']").val();

            if ($.trim(username) == '') {
                layer.msg("username不能为空");
                return;
            }
            if ($.trim(password) == '') {
                layer.msg("password不能为空");
                return;
            }
            if(password != re_pass) {
                layer.msg("密码不一样");
                return;
            }

            $.ajax({
                url: '/travel/save',
                data: $("#form-submit").serialize(),
                type: 'post',
                dataType: 'json',
                success: function (result) {
                    if (result.code == 200) {
                        window.location.href = "/travel";
                        console.log("success")
                    } else {
                        alert(result.message);
                    }
                }
            })
        }


        var settings = {
            e: 'idcode',
            codeType: {
                name: 'follow',
                len: 4
            }, //len是修改验证码长度的
            codeTip: '换个验证码?',
            inputID: 'idcode-btn' //验证元素的ID
        };

        var _set = {
            storeLable: 'codeval',
            store: '#ehong-code-input',
            codeval: '#ehong-code'
        }

        // $.idcode = {
        //     getCode: function(option) {
        //         _commSetting(option);
        //         return _storeData(_set.storeLable, null);
        //     },
        //     setCode: function(option) {
        //         _commSetting(option);
        //         _setCodeStyle("#" + settings.e, settings.codeType.name, settings.codeType.len);
        //
        //     },
        //     validateCode: function(option) {
        //         _commSetting(option);
        //         var inputV;
        //         if (settings.inputID) {
        //             inputV = $('#' + settings.inputID).val();
        //
        //         } else {
        //             inputV = $(_set.store).val();
        //         }
        //         if (inputV.toUpperCase() == _storeData(_set.storeLable, null).toUpperCase()) { //修改的不区分大小写
        //             return true;
        //         } else {
        //             _setCodeStyle("#" + settings.e, settings.codeType.name, settings.codeType.len);
        //             return false;
        //         }
        //     }
        // };

        function _commSetting(option) {
            $.extend(settings, option);
        }

        function _storeData(dataLabel, data) {
            var store = $(_set.codeval).get(0);
            if (data) {
                $.data(store, dataLabel, data);
            } else {
                return $.data(store, dataLabel);
            }
        }

        function _setCodeStyle(eid, codeType, codeLength) {
            var codeObj = _createCode(settings.codeType.name, settings.codeType.len);
            var randNum = Math.floor(Math.random() * 6);
            var htmlCode = ''
            if (!settings.inputID) {
                htmlCode = '<span><input id="ehong-code-input" type="text" maxlength="4" /></span>';
            }
            htmlCode += '<div id="ehong-code" class="ehong-idcode-val ehong-idcode-val';
            htmlCode += String(randNum);
            htmlCode += '" href="#" onblur="return false" onfocus="return false" oncontextmenu="return false" onclick="$.idcode.setCode()">' + _setStyle(codeObj) + '</div>' + '<span id="ehong-code-tip-ck" class="ehong-code-val-tip" onclick="$.idcode.setCode()">' + settings.codeTip + '</span>';
            $(eid).html(htmlCode);
            _storeData(_set.storeLable, codeObj);
        }

        function _setStyle(codeObj) {
            var fnCodeObj = new Array();
            var col = new Array('#BF0C43', '#E69A2A', '#707F02', '#18975F', '#BC3087', '#73C841', '#780320', '#90719B', '#1F72D8', '#D6A03C', '#6B486E', '#243F5F', '#16BDB5');
            var charIndex;
            for (var i = 0; i < codeObj.length; i++) {
                charIndex = Math.floor(Math.random() * col.length);
                fnCodeObj.push('<font color="' + col[charIndex] + '">' + codeObj.charAt(i) + '</font>');
            }
            return fnCodeObj.join('');
        }

        function _createCode(codeType, codeLength) {
            var codeObj;
            if (codeType == 'follow') {
                codeObj = _createCodeFollow(codeLength);
            } else if (codeType == 'calc') {
                codeObj = _createCodeCalc(codeLength);
            } else {
                codeObj = "";
            }
            return codeObj;
        }

        function _createCodeCalc(codeLength) {
            var code1, code2, codeResult;
            var selectChar = new Array('0', '1', '2', '3', '4', '5', '6', '7', '8', '9');
            var charIndex;
            for (var i = 0; i < codeLength; i++) {
                charIndex = Math.floor(Math.random() * selectChar.length);
                code1 += selectChar[charIndex];

                charIndex = Math.floor(Math.random() * selectChar.length);
                code2 += selectChar[charIndex];
            }
            return [parseInt(code1), parseInt(code2), parseInt(code1) + parseInt(code2)];
        }

        function _createCodeFollow(codeLength) {
            var code = "";
            var selectChar = new Array('0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z');

            for (var i = 0; i < codeLength; i++) {
                var charIndex = Math.floor(Math.random() * selectChar.length);
                if (charIndex % 2 == 0) {
                    code += selectChar[charIndex].toLowerCase();
                } else {
                    code += selectChar[charIndex];
                }
            }
            return code;
        }

        var regUsername = /^[a-zA-Z_][a-zA-Z0-9_]{4,19}$/;
        var regPasswordSpecial = /[~!@#%&=;':",./<>_\}\]\-\$\(\)\*\+\.\[\?\\\^\{\|]/;
        var regPasswordAlpha = /[a-zA-Z]/;
        var regPasswordNum = /[0-9]/;
        var password;
        var check = [false, false, false, false, false, false];

        //校验成功函数
        function success(Obj, counter) {
            Obj.parent().parent().removeClass('has-error').addClass('has-success');
            $('.tips').eq(counter).hide();
            $('.glyphicon-ok').eq(counter).show();
            $('.glyphicon-remove').eq(counter).hide();
            check[counter] = true;

        }

        // 校验失败函数
        function fail(Obj, counter, msg) {
            Obj.parent().parent().removeClass('has-success').addClass('has-error');
            $('.glyphicon-remove').eq(counter).show();
            $('.glyphicon-ok').eq(counter).hide();
            $('.tips').eq(counter).text(msg).show();
            check[counter] = false;
        }

        // 用户名匹配
        $('.container').find('input').eq(0).change(function () {
            if (regUsername.test($(this).val())) {
                success($(this), 0);
            } else if ($(this).val().length < 5) {
                fail($(this), 0, '用户名太短，不能少于5个字符');
            } else {
                fail($(this), 0, '用户名只能为英文数字和下划线,且不能以数字开头')
            }

        });


        // 密码匹配

        // 匹配字母、数字、特殊字符至少两种的函数
        function atLeastTwo(password) {
            var a = regPasswordSpecial.test(password) ? 1 : 0;
            var b = regPasswordAlpha.test(password) ? 1 : 0;
            var c = regPasswordNum.test(password) ? 1 : 0;
            return a + b + c;
        }

        $('.container').find('input').eq(1).change(function () {
            password = $(this).val();
            if ($(this).val().length < 8) {
                fail($(this), 1, '密码太短，不能少于8个字符');
            } else {
                if (atLeastTwo($(this).val()) < 2) {
                    fail($(this), 1, '密码中至少包含字母、数字、特殊字符的两种')
                } else {
                    success($(this), 1);
                }
            }
        });


        // 再次输入密码校验
        $('.container').find('input').eq(2).change(function () {
            if ($(this).val() == password) {
                success($(this), 2);
            } else {
                fail($(this), 2, '两次输入的密码不一致');
            }
        });


        $('#loadingButton').click(function () {

            if (check[4]) {
                $(this).removeClass('btn-primary').addClass('disabled');

                $(this).html('<span class="red">59</span> 秒后重新获取');
                var secondObj = $('#loadingButton').find('span');
                var secondObjVal = secondObj.text();

                function secondCounter() {

                    var secondTimer = setTimeout(function () {
                        secondObjVal--;
                        secondObj.text(secondObjVal);
                        secondCounter();
                    }, 1000);
                    if (secondObjVal == 0) {
                        clearTimeout(secondTimer);
                        $('#loadingButton').text('重新获取校验码');
                        $('#loadingButton').removeClass('disabled').addClass('btn-primary');

                    }
                }

                secondCounter();
            } else {
                $('.container').find('input').eq(4).parent().parent().removeClass('has-success').addClass('has-error');
            }

        })

        $('#submit').click(function (e) {
            if (!check.every(function (value) {
                return value == true
            })) {
                e.preventDefault();
                for (key in check) {
                    if (!check[key]) {
                        $('.container').find('input').eq(key).parent().parent().removeClass('has-success').addClass('has-error')
                    }
                }
            }
        });

        $('#reset').click(function () {
            $('input').slice(0, 6).parent().parent().removeClass('has-error has-success');
            $('.tips').hide();
            $('.glyphicon-ok').hide();
            $('.glyphicon-remove').hide();
            check = [false, false, false, false, false, false,];
        });

    </script>
</div>
</html>
